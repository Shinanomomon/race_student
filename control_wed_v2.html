<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Control micro:bit via ESP8266</title>
  <style>
    body { font-family: sans-serif; text-align: center; margin-top: 30px; }
    input, button {
      font-size: 18px;
      padding: 10px;
      margin: 10px;
    }
    button.cmd {
      width: 80px;
      height: 80px;
      font-size: 20px;
      margin: 10px;
    }
    .row { margin: 10px 0; }
    #status { margin-top: 15px; font-weight: bold; color: green; }
  </style>
</head>
<body>

  <h2>üîß ‡∏Å‡∏£‡∏≠‡∏Å IP ‡∏Ç‡∏≠‡∏á ESP8266</h2>
  <div>
    <label>ESP IP:</label>
    <input type="text" id="esp-ip" placeholder="‡πÄ‡∏ä‡πà‡∏ô 192.168.4.1" />
    <button onclick="setESPIP()">‚úÖ ‡∏ï‡∏Å‡∏•‡∏á</button>
  </div>

  <div id="control-panel" style="display: none;">
    <h3>üïπ ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏° micro:bit</h3>
    <div class="row">
      <button class="cmd" onmousedown="startSend('U')" onmouseup="stopSend()">‚¨ÜÔ∏è</button>
    </div>
    <div class="row">
      <button class="cmd" onmousedown="startSend('L')" onmouseup="stopSend()">‚¨ÖÔ∏è</button>
      <button class="cmd" onmousedown="startSend('C')" onmouseup="stopSend()">‚èπÔ∏è</button>
      <button class="cmd" onmousedown="startSend('R')" onmouseup="stopSend()">‚û°Ô∏è</button>
    </div>
    <div class="row">
      <button class="cmd" onmousedown="startSend('D')" onmouseup="stopSend()">‚¨áÔ∏è</button>
    </div>
    <div class="row">
      <button onclick="sendCmd('S+')">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß</button>
      <button onclick="sendCmd('S-')">‚ûñ ‡∏•‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß</button>
    </div>
    <p id="status">Status: ‡∏£‡∏≠‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á...</p>
  </div>

  <script>
    let espIP = "";
    let interval = null;

    function setESPIP() {
      const input = document.getElementById("esp-ip").value.trim();
      if (!input.match(/^(\d{1,3}\.){3}\d{1,3}$/)) {
        alert("‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà IP ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡πÄ‡∏ä‡πà‡∏ô 192.168.1.100");
        return;
      }
      espIP = `http://${input}`;
      document.getElementById("control-panel").style.display = "block";
      document.getElementById("status").textContent = "‚úÖ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö " + espIP;
      document.getElementById("status").style.color = "green";
    }

    function startSend(cmd) {
      sendCmd(cmd); // ‡∏™‡πà‡∏á‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
      interval = setInterval(() => sendCmd(cmd), 200);
    }

    function stopSend() {
      clearInterval(interval);
    }

    function sendCmd(cmd) {
      if (!espIP) return;

      fetch(`${espIP}/cmd?d=${cmd}`)
        .then((res) => {
          if (!res.ok) throw new Error("‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
          return res.text();
        })
        .then((text) => {
          document.getElementById("status").textContent = "‚úÖ ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á: " + cmd;
          document.getElementById("status").style.color = "green";
        })
        .catch((err) => {
          document.getElementById("status").textContent = "‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö ESP ‡πÑ‡∏î‡πâ";
          document.getElementById("status").style.color = "red";
          console.error(err);
        });
    }
  </script>

</body>
</html>
